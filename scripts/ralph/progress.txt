# Ralph Progress Log
Started: 2026-02-21
---

## Codebase Patterns
- Cloud Functions (index.ts): v1 compat 사용 - 함수 시그니처 `(data: any, context)` 형태 (NOT `(request)`)
- Flutter 텍스트: `AppTheme.nanum()`, `AppTheme.serif()` 사용 (기본 그림자 내장)
- 색상: `withOpacity()` 대신 `withValues(alpha:)` 사용
- 좌석 등급 순서: 항상 VIP > R > S > A
- Admin: shadcn_flutter 사용시 `import as shad`
- 배포: ticket app은 git push로 Vercel 자동배포, admin은 `firebase deploy --only hosting:admin`

## 2026-02-21 - Pre-Ralph Setup
- Cloud Functions v1/v2 시그니처 불일치 수정 완료 (8개 함수 모두)
- 모의 티켓 생성 화면 (mock_ticket_screen.dart) 구축 완료
- 체크아웃 수량/가격 버그 수정, 텍스트 그림자 전역 적용
---

## 2026-02-21 - MT-001 (스캐너 수동 QR 입력 모드 추가)
- Already implemented before Ralph started
- scanner_screen.dart: _showManualQrInput() method with AlertDialog, keyboard icon button in header
- Passes flutter analyze
- **Learnings:** Check existing code before implementing - features may already exist
---

## 2026-02-21 - MT-002 (티켓 상세 QR 데이터 클립보드 복사 버튼)
- Already implemented before Ralph started
- ticket_detail_screen.dart: _QrSection has TextButton.icon with copy functionality
- Uses Clipboard.setData + SnackBar feedback, only shown when _qrData != null
- Passes flutter analyze
- **Learnings:** Same as MT-001 - pre-existing implementation
---

## 2026-02-21 - MT-003 (모의예매 전체 플로우 오류 수정)
- **Fix 1**: confirmPaymentAndAssignSeats now returns `ticketIds` array in response
  - Added `ticketIds: string[]` collection in ticket creation loop (index.ts)
  - Added `ticketIds` to return object
- **Fix 2**: demo_test_screen.dart QR token key mismatch
  - Changed `qrResult['qrData']` → `qrResult['token']` (matching Cloud Function's actual return key)
- **Cleanup**: Removed unused `_orderResult`, `_confirmResult` fields and unused `ticket.dart` import
- Files changed: `functions/src/index.ts`, `melon_admin/lib/features/admin/demo_test_screen.dart`
- flutter analyze (admin): 0 warnings, npm run build: pass
- **Learnings for future iterations:**
  - Cloud Function returns must match client expectations (field name mismatches are common)
  - issueQrToken returns `{ token: "ticketId:jwt" }` NOT `{ qrData: ... }`
  - confirmPaymentAndAssignSeats transaction creates tickets but previously didn't return their IDs
  - mock_ticket_screen.dart uses direct Firestore batch writes (bypasses Cloud Functions intentionally)
---

## 2026-02-21 - MT-004 (취소/환불 시 좌석 상태 복원 및 엣지케이스 처리)
- **Backend (Cloud Function)**: requestTicketCancellation already handles all required logic:
  - Seat status → available, event.availableSeats +1
  - Partial cancel: order.canceledCount increment, order.status stays paid
  - Full cancel: order.status → refunded
  - Checked-in ticket rejection with clear error message
  - Refund rate: 100% (24h+), 70% (3-24h), blocked (<3h)
- **Fix 1**: ticket_detail_screen.dart canRequestCancel now checks `!ticket.hasAnyCheckin`
  - Previously a ticket with entryCheckedInAt (status still "issued") could show cancel button
- **Fix 2**: Error messages parsed from Firebase HttpsError format to show user-friendly Korean messages
  - Added `_parseFirebaseError()` helper that extracts message from `[firebase_functions/code] message` format
- **Fix 3**: Bottom action bar shows "입장확인" for checked-in issued tickets (instead of generic "취소불가")
- **Fix 4**: Order model updated with `canceledCount` and `refundedAmount` fields
  - Default values (0) ensure backward compatibility with existing Firestore documents
- Files changed: `melon_core/lib/data/models/order.dart`, `melon_ticket_app/lib/features/tickets/ticket_detail_screen.dart`
- flutter analyze: pass (pre-existing info-level issues only), npm run build: pass
- **Learnings for future iterations:**
  - Ticket status "issued" doesn't mean the ticket hasn't been checked in - check `hasAnyCheckin` separately
  - Status becomes "used" only after intermission checkin (2nd stage), not entry checkin (1st stage)
  - Firebase error format is `[firebase_functions/error-code] Korean message` - parse to extract readable part
  - Cloud Function already had complete logic - main work was client-side edge case handling
---

## 2026-02-21 - MT-005 (마일리지 데이터 모델 및 Firestore 구조 설계)
- **Mileage model** (`melon_core/lib/data/models/mileage.dart`):
  - `Mileage` class with balance, tier (MileageTier enum), totalEarned
  - `fromMap()` constructor (not fromFirestore - it's a sub-document of users)
  - `MileageTier` enum: bronze(0~), silver(5000~), gold(15000~), platinum(30000~)
  - Helper methods: `fromTotalEarned()`, `next`, `minPoints`, `displayName`
- **MileageHistory model** (`melon_core/lib/data/models/mileage_history.dart`):
  - Standard Firestore model with `fromFirestore()` and `toMap()`
  - `MileageType` enum: purchase, referral, upgrade
- **AppUser updated** (`melon_core/lib/data/models/app_user.dart`):
  - Added `Mileage mileage` field with default `Mileage()` for backward compat
  - `fromFirestore()` reads `data['mileage']` as `Map<String, dynamic>?`
  - `toMap()` includes `mileage.toMap()`
- **Barrel export** (`models.dart`): Added `mileage.dart` and `mileage_history.dart`
- **addMileage Cloud Function** (`functions/src/index.ts`):
  - Admin-only callable function
  - Validates userId, amount (non-zero number), type (purchase/referral/upgrade), reason
  - Checks balance sufficiency for deductions (amount < 0)
  - Creates mileageHistory doc + updates users.mileage.balance/tier/totalEarned
  - Tier auto-calculated from totalEarned
- **Social login updated**: signInWithKakao, signInWithNaver now set `mileage: { balance: 0, tier: "bronze", totalEarned: 0 }` on new user creation
- Files changed: `melon_core/lib/data/models/mileage.dart` (new), `mileage_history.dart` (new), `app_user.dart`, `models.dart`, `functions/src/index.ts`
- flutter analyze: pass (all 3 packages), npm run build: pass, functions deployed
- **Learnings for future iterations:**
  - Mileage is a sub-document of users (not a separate collection) - use `fromMap()` not `fromFirestore()`
  - Tier is calculated from totalEarned (cumulative), not balance (current)
  - addMileage uses dot notation updates (`mileage.balance`) instead of replacing entire mileage object
  - Social login functions (signInWithKakao, signInWithNaver) also create user docs - don't forget to add new fields there
  - Existing users without mileage field will get defaults from `Mileage.fromMap(null)` → balance:0, tier:bronze
---

## 2026-02-21 - MT-006 (추천 코드 생성 및 공유하기 기능)
- **referralCode utility** (`melon_core/lib/utils/referral_code.dart`):
  - `generateReferralCode()` → 8자리 영숫자 (혼동 문자 제외: 0/O, 1/I)
  - Uses `Random.secure()` for cryptographic randomness
- **AppUser model updated** (`melon_core/lib/data/models/app_user.dart`):
  - Added `String? referralCode` field
  - `fromFirestore()` reads `data['referralCode']`
  - `toMap()` conditionally includes referralCode
- **Auth service updated** (`melon_core/lib/services/auth_service.dart`):
  - `_createUserDocument()` now generates unique referralCode for email/Google signups
  - `_generateUniqueReferralCode()` checks Firestore for duplicates (up to 10 attempts)
  - Also now sets `mileage` default fields on user creation
- **Cloud Functions updated** (`functions/src/index.ts`):
  - Added `generateReferralCode()` and `generateUniqueReferralCode()` helper functions
  - signInWithKakao: generates referralCode for new users
  - signInWithNaver: generates referralCode for new users
- **Share sheet updated** (`event_detail_screen.dart`):
  - `_buildShareUrl()` appends `?ref={referralCode}` when user is logged in
  - Watches `currentUserProvider` to get referral code
  - Added native Web Share API support via `tryWebShare()` (navigator.share)
  - Fallback to clipboard copy when Share API unavailable
  - Two buttons: "SHARE LINK" (tries native share) + "COPY LINK" (clipboard only)
- **Web share utility** (`melon_ticket_app/lib/utils/`):
  - Conditional import pattern: `web_share.dart` → `web_share_web.dart` (web) / `web_share_stub.dart` (non-web)
  - Uses `dart:js_interop` for `navigator.share()` call
- Files changed: `melon_core/lib/utils/referral_code.dart` (new), `app_user.dart`, `auth_service.dart`, `melon_core.dart`, `functions/src/index.ts`, `event_detail_screen.dart`, `web_share*.dart` (new)
- flutter analyze: pass (all packages), npm run build: pass, functions deployed
- **Learnings for future iterations:**
  - Web Share API (`navigator.share`) requires HTTPS and user gesture; may not be available in all browsers
  - Conditional import with `dart.library.js_interop` targets web platform specifically
  - `@JS('navigator.share')` annotation maps directly to JS function — use `JSObject` with `.jsify()` for share data
  - referralCode should be generated at signup time (not lazily) to simplify downstream logic
  - Existing users won't have referralCode — the field is nullable, so sharing works without it (just no ?ref= param)
  - Auth _createUserDocument was missing mileage defaults for email/Google — now fixed alongside referralCode
---

## 2026-02-21 - MT-007 (추천 링크로 예매 시 추천인 마일리지 적립)
- **Client-side ref capture** (`checkout_screen.dart`):
  - Reads `ref` query parameter from `Uri.base` (web only, via `kIsWeb`)
  - Passes `referralCode` to `FunctionsService.createOrder()`
- **FunctionsService updated** (`functions_service.dart`):
  - `createOrder()` now accepts optional `referralCode` parameter
- **createOrder Cloud Function** (`index.ts`):
  - Validates `referralCode` (string, non-empty, trimmed)
  - Stores `referralCode` in order document (only if present)
- **confirmPaymentAndAssignSeats updated** (`index.ts`):
  - After transaction success, processes mileage rewards (outside transaction to keep it lightweight):
    1. **Purchase mileage**: Buyer gets `Math.floor(totalAmount * 0.05)` points (type: "purchase")
    2. **Referral mileage**: If order has `referralCode`, find referrer by `referralCode` field → give 500P (type: "referral")
    3. **Self-referral prevention**: Skips if `referrerId === buyerId`
  - Mileage errors are caught and logged but don't affect payment success
- **addMileageInternal helper** (`index.ts`):
  - New internal function for server-side mileage operations (no admin auth check)
  - Same logic as `addMileage` callable: updates balance, tier, totalEarned + creates mileageHistory record
  - Checks balance sufficiency for deductions
- Files changed: `melon_core/lib/services/functions_service.dart`, `melon_ticket_app/lib/features/checkout/checkout_screen.dart`, `melon_ticket_app/functions/src/index.ts`
- npm run build: pass, flutter analyze: pass (pre-existing info-level only), functions deployed
- **Learnings for future iterations:**
  - `Uri.base` on web contains the full browser URL including query params — simplest way to capture `ref` without threading it through multiple screens
  - Mileage processing should always be outside the main transaction to avoid making it heavier
  - `addMileageInternal` avoids circular callable invocation and removes admin-only restriction for server-side usage
  - Self-referral check is critical: user could share their own link and buy through it
  - Mileage failures should never block successful payment — use try/catch wrapper
---

## 2026-02-21 - MT-008 (마이페이지 마일리지 현황 UI)
- **MileageRepository** (`melon_core/lib/data/repositories/mileage_repository.dart`):
  - New repository with `getMileageHistory(userId, limit)` stream
  - `mileageHistoryStreamProvider` using record type params `({String userId, int limit})`
  - Queries `mileageHistory` collection ordered by `createdAt` desc
- **Barrel export** (`melon_core.dart`): Added `mileage_repository.dart`
- **Profile tab mileage card** (`mobile_main_screen.dart`):
  - `_MileageCard` widget: tier badge + balance, progress bar to next tier, recent 3 history items
  - `_MileageHistoryRow` widget: compact row with type, reason, amount (+/-), date
  - "전체 내역 보기" link when >3 items → navigates to `/mileage`
  - Tier colors: Bronze(#CD7F32), Silver(#C0C0C0), Gold(#C9A84C), Platinum(#E5E4E2)
  - Tier icons: circle, hexagon, star, diamond
- **MileageHistoryScreen** (`melon_ticket_app/lib/features/mileage/mileage_history_screen.dart`):
  - Full mileage detail page with summary card + complete history list (up to 50 items)
  - Summary card: tier badge, balance, progress bar to next tier with remaining points
  - History items: type icon + name, reason, amount with color coding (green +, red -), datetime
- **Router** (`router.dart`): Added `/mileage` route with auth guard
- **mileage.dart fix**: Removed unused `cloud_firestore` import
- Files changed: `mileage.dart`, `mileage_repository.dart` (new), `melon_core.dart`, `mileage_history_screen.dart` (new), `mobile_main_screen.dart`, `router.dart`
- flutter analyze: pass (all packages, 0 new issues), pushed to Vercel
- **Learnings for future iterations:**
  - Mileage is a sub-document of users — accessed via `currentUserProvider.value.mileage` (no separate provider needed)
  - mileageHistory is a top-level collection (not a subcollection) — query by userId
  - Record type parameters for family providers: `({String userId, int limit})` syntax
  - Profile tab `_ProfileTab` is a `ConsumerWidget` — easy to add more ref.watch() calls
  - AppTheme colors are const — can use `const BoxDecoration` / `const Divider` for perf
  - Tier progress: `(totalEarned - tier.minPoints) / (nextTier.minPoints - tier.minPoints)`
---

## 2026-02-21 - MT-009 (마일리지로 좌석 등급 업그레이드)
- **upgradeTicketSeat Cloud Function** (`functions/src/index.ts`):
  - Transaction-based: validates ticket ownership, status=issued, current grade, mileage balance
  - Grade order: A → S → R → VIP, costs: A→S(2000P), S→R(3000P), R→VIP(5000P)
  - Swaps seats atomically: old seat → available, new higher-grade seat → reserved
  - Updates ticket.seatId + stores previousSeatId/upgradedAt for audit
  - Deducts mileage from user balance + creates mileageHistory record (type: "upgrade")
  - Returns newGrade, newSeatId, newSeatDisplay, cost, newBalance
  - VIP tickets get "더 이상 업그레이드할 수 없습니다" error
  - No available higher-grade seats → clear error message with target grade name
- **FunctionsService** (`melon_core/lib/services/functions_service.dart`):
  - Added `upgradeTicketSeat(ticketId)` method
- **Ticket Detail UI** (`ticket_detail_screen.dart`):
  - `_UpgradeCard` widget: shows currentGrade → targetGrade badges, cost, balance, upgrade button
  - Conditionally displayed: status=issued, not checked-in, grade != VIP, user logged in
  - `_GradeBadge` widget: color-coded grade badges (VIP gold, R purple, S green, A blue)
  - Confirmation dialog with grade badges + cost display before executing upgrade
  - Success: SnackBar with new grade + seat display; Error: parsed Firebase error message
  - `hasEnoughMileage` check: insufficient balance shows disabled "마일리지 부족" button
  - Watches `currentUserProvider` for mileage balance
- Files changed: `functions/src/index.ts`, `functions_service.dart`, `ticket_detail_screen.dart`
- flutter analyze: pass (0 new issues), npm run build: pass, functions deployed
- **Learnings for future iterations:**
  - Seat grade is stored on the Seat model (`seat.grade`), not on the ticket
  - Transaction reads within Firestore can query by `.where()` — used to find available seats of target grade
  - `previousSeatId` on ticket doc is useful for audit trail of upgrades
  - Grade color constants: VIP(#C9A84C), R(#6B4FA0), S(#2D6A4F), A(#3B7DD8) — same as seat selection screen
  - `canUpgrade` must also check `!ticket.hasAnyCheckin` — can't upgrade after entry
  - Mileage balance check is dual: client-side (UI enable/disable) + server-side (transaction validation)
---

## 2026-02-21 - MT-010 (추천 코드 & 마일리지 어드민 관리)
- **AdminMileageScreen** (`melon_admin/lib/features/admin/admin_mileage_screen.dart`):
  - Full editorial admin screen with summary cards, tier distribution, user table
  - **Summary cards**: Total users, total balance, total earned, referral users count
  - **Tier distribution**: 4 clickable tier cards (Bronze/Silver/Gold/Platinum) with progress bars, acts as filter
  - **User table**: Name, email, referral code, tier badge, balance, total earned, action buttons
  - **Search**: Real-time search by email, name, or referral code
  - **Manual adjust dialog**: Toggle between 지급/차감, amount input, reason input, calls `addMileage` Cloud Function with `[관리자]` prefix
  - **History dialog**: StreamBuilder on `mileageHistory` collection, shows type, reason, amount (+/-), date
- **Router** (`router.dart`): Added `/mileage` route → `AdminMileageScreen`
- **Sidebar** (`web_admin_dashboard.dart`): Added menu item `05 마일리지 관리` with push to `/mileage`
- **pubspec.yaml**: Added `cloud_functions: ^5.1.5` as direct dependency (needed for `FirebaseFunctions.instance.httpsCallable`)
- Files changed: `admin_mileage_screen.dart` (new), `router.dart`, `web_admin_dashboard.dart`, `pubspec.yaml`
- flutter analyze: pass (0 new issues), admin deployed to Firebase Hosting
- **Learnings for future iterations:**
  - `AdminTheme.sans()` does not accept `fontFamily` parameter — it's a fixed TextStyle factory
  - `cloud_functions` was only a transitive dependency of melon_admin via melon_core — needs explicit dep if used directly
  - `sum` as a fold parameter name conflicts with Dart's built-in `sum` type — use `s` instead
  - Tier colors: Bronze(#CD7F32), Silver(#C0C0C0), Gold(#C9A84C), Platinum(#E5E4E2) — consistent across ticket app and admin
  - StreamBuilder works well for admin dialogs (history list) without needing Riverpod providers
  - `addMileage` Cloud Function is admin-only — perfect for manual adjustments with `[관리자]` reason prefix
---

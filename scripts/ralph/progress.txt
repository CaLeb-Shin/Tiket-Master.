# Ralph Progress Log
Started: 2026-02-21
---

## Codebase Patterns
- Cloud Functions (index.ts): v1 compat 사용 - 함수 시그니처 `(data: any, context)` 형태 (NOT `(request)`)
- Flutter 텍스트: `AppTheme.nanum()`, `AppTheme.serif()` 사용 (기본 그림자 내장)
- 색상: `withOpacity()` 대신 `withValues(alpha:)` 사용
- 좌석 등급 순서: 항상 VIP > R > S > A
- Admin: shadcn_flutter 사용시 `import as shad`
- 배포: ticket app은 git push로 Vercel 자동배포, admin은 `firebase deploy --only hosting:admin`

## 2026-02-21 - Pre-Ralph Setup
- Cloud Functions v1/v2 시그니처 불일치 수정 완료 (8개 함수 모두)
- 모의 티켓 생성 화면 (mock_ticket_screen.dart) 구축 완료
- 체크아웃 수량/가격 버그 수정, 텍스트 그림자 전역 적용
---

## 2026-02-21 - MT-001 (스캐너 수동 QR 입력 모드 추가)
- Already implemented before Ralph started
- scanner_screen.dart: _showManualQrInput() method with AlertDialog, keyboard icon button in header
- Passes flutter analyze
- **Learnings:** Check existing code before implementing - features may already exist
---

## 2026-02-21 - MT-002 (티켓 상세 QR 데이터 클립보드 복사 버튼)
- Already implemented before Ralph started
- ticket_detail_screen.dart: _QrSection has TextButton.icon with copy functionality
- Uses Clipboard.setData + SnackBar feedback, only shown when _qrData != null
- Passes flutter analyze
- **Learnings:** Same as MT-001 - pre-existing implementation
---

## 2026-02-21 - MT-003 (모의예매 전체 플로우 오류 수정)
- **Fix 1**: confirmPaymentAndAssignSeats now returns `ticketIds` array in response
  - Added `ticketIds: string[]` collection in ticket creation loop (index.ts)
  - Added `ticketIds` to return object
- **Fix 2**: demo_test_screen.dart QR token key mismatch
  - Changed `qrResult['qrData']` → `qrResult['token']` (matching Cloud Function's actual return key)
- **Cleanup**: Removed unused `_orderResult`, `_confirmResult` fields and unused `ticket.dart` import
- Files changed: `functions/src/index.ts`, `melon_admin/lib/features/admin/demo_test_screen.dart`
- flutter analyze (admin): 0 warnings, npm run build: pass
- **Learnings for future iterations:**
  - Cloud Function returns must match client expectations (field name mismatches are common)
  - issueQrToken returns `{ token: "ticketId:jwt" }` NOT `{ qrData: ... }`
  - confirmPaymentAndAssignSeats transaction creates tickets but previously didn't return their IDs
  - mock_ticket_screen.dart uses direct Firestore batch writes (bypasses Cloud Functions intentionally)
---

## 2026-02-21 - MT-004 (취소/환불 시 좌석 상태 복원 및 엣지케이스 처리)
- **Backend (Cloud Function)**: requestTicketCancellation already handles all required logic:
  - Seat status → available, event.availableSeats +1
  - Partial cancel: order.canceledCount increment, order.status stays paid
  - Full cancel: order.status → refunded
  - Checked-in ticket rejection with clear error message
  - Refund rate: 100% (24h+), 70% (3-24h), blocked (<3h)
- **Fix 1**: ticket_detail_screen.dart canRequestCancel now checks `!ticket.hasAnyCheckin`
  - Previously a ticket with entryCheckedInAt (status still "issued") could show cancel button
- **Fix 2**: Error messages parsed from Firebase HttpsError format to show user-friendly Korean messages
  - Added `_parseFirebaseError()` helper that extracts message from `[firebase_functions/code] message` format
- **Fix 3**: Bottom action bar shows "입장확인" for checked-in issued tickets (instead of generic "취소불가")
- **Fix 4**: Order model updated with `canceledCount` and `refundedAmount` fields
  - Default values (0) ensure backward compatibility with existing Firestore documents
- Files changed: `melon_core/lib/data/models/order.dart`, `melon_ticket_app/lib/features/tickets/ticket_detail_screen.dart`
- flutter analyze: pass (pre-existing info-level issues only), npm run build: pass
- **Learnings for future iterations:**
  - Ticket status "issued" doesn't mean the ticket hasn't been checked in - check `hasAnyCheckin` separately
  - Status becomes "used" only after intermission checkin (2nd stage), not entry checkin (1st stage)
  - Firebase error format is `[firebase_functions/error-code] Korean message` - parse to extract readable part
  - Cloud Function already had complete logic - main work was client-side edge case handling
---

## 2026-02-21 - MT-005 (마일리지 데이터 모델 및 Firestore 구조 설계)
- **Mileage model** (`melon_core/lib/data/models/mileage.dart`):
  - `Mileage` class with balance, tier (MileageTier enum), totalEarned
  - `fromMap()` constructor (not fromFirestore - it's a sub-document of users)
  - `MileageTier` enum: bronze(0~), silver(5000~), gold(15000~), platinum(30000~)
  - Helper methods: `fromTotalEarned()`, `next`, `minPoints`, `displayName`
- **MileageHistory model** (`melon_core/lib/data/models/mileage_history.dart`):
  - Standard Firestore model with `fromFirestore()` and `toMap()`
  - `MileageType` enum: purchase, referral, upgrade
- **AppUser updated** (`melon_core/lib/data/models/app_user.dart`):
  - Added `Mileage mileage` field with default `Mileage()` for backward compat
  - `fromFirestore()` reads `data['mileage']` as `Map<String, dynamic>?`
  - `toMap()` includes `mileage.toMap()`
- **Barrel export** (`models.dart`): Added `mileage.dart` and `mileage_history.dart`
- **addMileage Cloud Function** (`functions/src/index.ts`):
  - Admin-only callable function
  - Validates userId, amount (non-zero number), type (purchase/referral/upgrade), reason
  - Checks balance sufficiency for deductions (amount < 0)
  - Creates mileageHistory doc + updates users.mileage.balance/tier/totalEarned
  - Tier auto-calculated from totalEarned
- **Social login updated**: signInWithKakao, signInWithNaver now set `mileage: { balance: 0, tier: "bronze", totalEarned: 0 }` on new user creation
- Files changed: `melon_core/lib/data/models/mileage.dart` (new), `mileage_history.dart` (new), `app_user.dart`, `models.dart`, `functions/src/index.ts`
- flutter analyze: pass (all 3 packages), npm run build: pass, functions deployed
- **Learnings for future iterations:**
  - Mileage is a sub-document of users (not a separate collection) - use `fromMap()` not `fromFirestore()`
  - Tier is calculated from totalEarned (cumulative), not balance (current)
  - addMileage uses dot notation updates (`mileage.balance`) instead of replacing entire mileage object
  - Social login functions (signInWithKakao, signInWithNaver) also create user docs - don't forget to add new fields there
  - Existing users without mileage field will get defaults from `Mileage.fromMap(null)` → balance:0, tier:bronze
---

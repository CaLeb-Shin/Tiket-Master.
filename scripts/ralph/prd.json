{
  "project": "MelonTicket",
  "branchName": "main",
  "description": "멜론티켓 - 공유/마일리지 시스템 + 모의예매 안정화 + QR 입장 테스트 환경",
  "userStories": [
    {
      "id": "MT-001",
      "title": "스캐너 수동 QR 입력 모드 추가",
      "description": "카메라가 없는 웹 환경에서도 QR 데이터를 수동 입력하여 체크인할 수 있도록 스캐너 화면에 수동 입력 기능을 추가한다.",
      "acceptanceCriteria": [
        "scanner_screen.dart 헤더에 키보드 아이콘 버튼 추가 (카메라 전환 옆)",
        "아이콘 클릭시 AlertDialog로 QR 문자열 붙여넣기 가능",
        "입력값을 기존 _processQrCode() 경로로 전달",
        "flutter analyze 통과"
      ],
      "priority": 1,
      "passes": true,
      "notes": "scanner_screen.dart의 _processQrCode 메서드를 재활용. 웹에서 카메라 없이 테스트 가능하게."
    },
    {
      "id": "MT-002",
      "title": "티켓 상세 QR 데이터 클립보드 복사 버튼",
      "description": "티켓 상세 화면의 QR 코드 아래에 복사 버튼을 추가하여 QR 데이터를 클립보드에 복사할 수 있게 한다. 스캐너 수동 입력에 붙여넣기 용도.",
      "acceptanceCriteria": [
        "ticket_detail_screen.dart의 _QrSection에 복사 버튼 추가",
        "_qrData가 있을 때만 버튼 표시",
        "클릭시 Clipboard.setData로 복사 + SnackBar 피드백",
        "import 'package:flutter/services.dart' 추가",
        "flutter analyze 통과"
      ],
      "priority": 2,
      "passes": true,
      "notes": "_QrSection 위젯 내부의 QR 유효시간 뱃지 아래에 추가. AppTheme.nanum(fontSize: 12) 스타일."
    },
    {
      "id": "MT-003",
      "title": "모의예매 전체 플로우 오류 수정 (예매~결제~발권)",
      "description": "데모 테스트 화면과 모의 티켓 생성을 통해 예매→결제→발권 플로우를 끝까지 오류 없이 완료할 수 있도록 수정한다. Cloud Functions 호출, Firestore 데이터 정합성 등 모든 단계 검증.",
      "acceptanceCriteria": [
        "demo_test_screen.dart에서 createOrder → confirmPaymentAndAssignSeats 순차 호출 성공",
        "mock_ticket_screen.dart에서 Firestore 직접 쓰기로 티켓 생성 성공",
        "생성된 티켓이 마이티켓에 정상 표시",
        "오류 발생 시 명확한 에러 메시지 표시 (INTERNAL 에러 X)",
        "flutter analyze 통과"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Cloud Functions는 이미 v1 시그니처로 수정 완료. 클라이언트 호출부가 올바른 파라미터를 보내는지 확인. demo_test_screen.dart, mock_ticket_screen.dart 점검."
    },
    {
      "id": "MT-004",
      "title": "취소/환불 시 좌석 상태 복원 및 엣지케이스 처리",
      "description": "티켓 취소 시 예약된 좌석이 다시 available로 풀리고, 주문/티켓/좌석블록 상태가 일관성 있게 업데이트되는지 확인. 부분 취소(2장 중 1장만), 전체 취소, 이미 입장한 티켓 취소 시도 등 엣지케이스 처리.",
      "acceptanceCriteria": [
        "requestTicketCancellation 호출 시 해당 좌석 status가 available로 복원",
        "event.availableSeats가 +1 증가",
        "주문 내 모든 티켓 취소 시 order.status가 refunded로 변경",
        "부분 취소 시 order.status 유지, canceledCount 증가",
        "이미 체크인된 티켓 취소 시도 시 적절한 에러 메시지",
        "취소 후 마이티켓에서 해당 티켓 상태가 '취소됨'으로 표시",
        "flutter analyze 통과, npm run build 통과"
      ],
      "priority": 4,
      "passes": true,
      "notes": "requestTicketCancellation Cloud Function은 이미 좌석 복원 로직 포함. 클라이언트 UI에서 취소 후 화면 갱신이 제대로 되는지 확인. ticket_detail_screen.dart의 취소 버튼 동작 점검."
    },
    {
      "id": "MT-005",
      "title": "마일리지 데이터 모델 및 Firestore 구조 설계",
      "description": "사용자 마일리지 시스템의 기초 데이터 모델을 설계하고 구현한다. users 문서에 mileage 필드 추가, mileageHistory 컬렉션 생성, 마일리지 적립/차감 Cloud Function 구현.",
      "acceptanceCriteria": [
        "melon_core에 Mileage 모델 추가 (balance, tier, totalEarned)",
        "melon_core에 MileageHistory 모델 추가 (userId, amount, type, reason, createdAt)",
        "type 종류: purchase(구매적립), referral(추천적립), upgrade(등급업 차감)",
        "users 문서에 mileage 필드 추가 (balance: 0, tier: 'bronze', totalEarned: 0)",
        "addMileage Cloud Function: userId, amount, type, reason → mileageHistory 기록 + users.mileage.balance 업데이트",
        "npm run build 통과, flutter analyze 통과"
      ],
      "priority": 5,
      "passes": true,
      "notes": "등급 체계: Bronze(0~) → Silver(5000~) → Gold(15000~) → Platinum(30000~). 구매 적립: 결제금액의 5%. 추천 적립: 추천인에게 500P."
    },
    {
      "id": "MT-006",
      "title": "추천 코드 생성 및 공유하기 기능",
      "description": "각 사용자에게 고유 추천 코드를 부여하고, 공연 상세 페이지에서 추천 코드가 포함된 링크를 공유할 수 있게 한다.",
      "acceptanceCriteria": [
        "users 문서에 referralCode 필드 추가 (최초 로그인 시 8자리 영숫자 자동 생성)",
        "melon_core에 referralCode 생성 유틸 추가",
        "event_detail_screen.dart에 공유 버튼 추가 (Share 아이콘)",
        "공유 시 URL 형식: https://melonticket-web-20260216.vercel.app/event/{eventId}?ref={referralCode}",
        "공유 방법: 클립보드 복사 + 네이티브 Share API (웹: navigator.share, 없으면 클립보드)",
        "공유 성공 시 SnackBar 피드백",
        "flutter analyze 통과"
      ],
      "priority": 6,
      "passes": false,
      "notes": "referralCode는 중복 불가. Firestore에서 유니크 체크. URL의 ref 파라미터는 예매 시 서버로 전달되어 추천인 추적에 사용."
    },
    {
      "id": "MT-007",
      "title": "추천 링크로 예매 시 추천인 마일리지 적립",
      "description": "추천 코드가 포함된 링크로 접속하여 예매를 완료하면, 추천인에게 마일리지가 적립되고 구매자에게도 구매 마일리지가 적립된다.",
      "acceptanceCriteria": [
        "예매 플로우에서 ref 쿼리 파라미터를 추출하여 주문에 저장 (order.referralCode)",
        "confirmPaymentAndAssignSeats에서 결제 성공 시: 구매자에게 결제금액 5% 마일리지 적립",
        "referralCode가 있으면: 추천인 userId 조회 → 추천인에게 500P 적립",
        "자기 자신 추천 방지 (referralCode 소유자 == 구매자이면 무시)",
        "mileageHistory에 적립 내역 기록",
        "npm run build 통과"
      ],
      "priority": 7,
      "passes": false,
      "notes": "createOrder에 referralCode 파라미터 추가. confirmPaymentAndAssignSeats 트랜잭션 외부에서 마일리지 적립 처리 (트랜잭션 무겁지 않게)."
    },
    {
      "id": "MT-008",
      "title": "마이페이지 마일리지 현황 UI",
      "description": "마이페이지에서 현재 마일리지 잔액, 등급, 적립 내역을 확인할 수 있는 UI를 구현한다.",
      "acceptanceCriteria": [
        "마이페이지(또는 마이티켓 화면)에 마일리지 섹션 추가",
        "현재 잔액 표시 (숫자 + P 단위)",
        "현재 등급 표시 (Bronze/Silver/Gold/Platinum + 아이콘/색상)",
        "다음 등급까지 남은 마일리지 프로그레스 바",
        "최근 적립/차감 내역 리스트 (최대 10건, 더보기 가능)",
        "내역 항목: 날짜, 유형(구매/추천/업그레이드), 금액(+/-), 사유",
        "flutter analyze 통과"
      ],
      "priority": 8,
      "passes": false,
      "notes": "디자인: 다크 테마 + 골드 악센트. 등급 색상 - Bronze(#CD7F32), Silver(#C0C0C0), Gold(#C9A84C), Platinum(#E5E4E2). AppTheme 활용."
    },
    {
      "id": "MT-009",
      "title": "마일리지로 좌석 등급 업그레이드",
      "description": "일정 마일리지를 모은 사용자가 보유한 티켓의 좌석 등급을 한 단계 업그레이드할 수 있는 기능. 할인이 아니라 구매 후 업그레이드 개념.",
      "acceptanceCriteria": [
        "티켓 상세 화면에 '좌석 업그레이드' 버튼 추가 (조건 충족 시만 표시)",
        "업그레이드 가능 조건: 티켓 status=issued, 상위 등급 잔여 좌석 존재, 충분한 마일리지",
        "업그레이드 비용: A→S(2000P), S→R(3000P), R→VIP(5000P)",
        "upgradeTicketSeat Cloud Function 구현: 마일리지 차감 + 기존 좌석 available로 반환 + 상위 등급 좌석 배정 + 티켓 seatId 업데이트",
        "업그레이드 성공 시 마일리지 차감 내역 기록 (type: upgrade)",
        "업그레이드 후 티켓 상세 화면에 새 좌석 정보 반영",
        "npm run build 통과, flutter analyze 통과"
      ],
      "priority": 9,
      "passes": false,
      "notes": "VIP는 더 이상 업그레이드 불가. 상위 등급 좌석이 없으면 '잔여 좌석이 없습니다' 메시지. 트랜잭션으로 좌석 교환 원자성 보장."
    },
    {
      "id": "MT-010",
      "title": "추천 코드 & 마일리지 어드민 관리",
      "description": "어드민 대시보드에서 사용자별 마일리지 현황, 추천 통계, 수동 마일리지 지급/차감이 가능한 관리 화면을 추가한다.",
      "acceptanceCriteria": [
        "admin 사이드바에 '마일리지 관리' 메뉴 추가",
        "사용자별 마일리지 잔액, 등급, 추천 횟수 목록 표시",
        "수동 마일리지 지급/차감 기능 (관리자용)",
        "추천 통계: 총 추천 수, 추천으로 발생한 예매 수",
        "flutter analyze 통과"
      ],
      "priority": 10,
      "passes": false,
      "notes": "melon_admin에 구현. AdminTheme, shadcn_flutter 사용. 기존 admin_orders_screen 스타일 참고."
    }
  ]
}

{
  "project": "MelonTicket",
  "branchName": "main",
  "description": "멜론티켓 - 공유/마일리지 시스템 + 모의예매 안정화 + QR 입장 테스트 환경",
  "userStories": [
    {
      "id": "MT-001",
      "title": "스캐너 수동 QR 입력 모드 추가",
      "description": "카메라가 없는 웹 환경에서도 QR 데이터를 수동 입력하여 체크인할 수 있도록 스캐너 화면에 수동 입력 기능을 추가한다.",
      "acceptanceCriteria": [
        "scanner_screen.dart 헤더에 키보드 아이콘 버튼 추가 (카메라 전환 옆)",
        "아이콘 클릭시 AlertDialog로 QR 문자열 붙여넣기 가능",
        "입력값을 기존 _processQrCode() 경로로 전달",
        "flutter analyze 통과"
      ],
      "priority": 1,
      "passes": true,
      "notes": "scanner_screen.dart의 _processQrCode 메서드를 재활용. 웹에서 카메라 없이 테스트 가능하게."
    },
    {
      "id": "MT-002",
      "title": "티켓 상세 QR 데이터 클립보드 복사 버튼",
      "description": "티켓 상세 화면의 QR 코드 아래에 복사 버튼을 추가하여 QR 데이터를 클립보드에 복사할 수 있게 한다. 스캐너 수동 입력에 붙여넣기 용도.",
      "acceptanceCriteria": [
        "ticket_detail_screen.dart의 _QrSection에 복사 버튼 추가",
        "_qrData가 있을 때만 버튼 표시",
        "클릭시 Clipboard.setData로 복사 + SnackBar 피드백",
        "import 'package:flutter/services.dart' 추가",
        "flutter analyze 통과"
      ],
      "priority": 2,
      "passes": true,
      "notes": "_QrSection 위젯 내부의 QR 유효시간 뱃지 아래에 추가. AppTheme.nanum(fontSize: 12) 스타일."
    },
    {
      "id": "MT-003",
      "title": "모의예매 전체 플로우 오류 수정 (예매~결제~발권)",
      "description": "데모 테스트 화면과 모의 티켓 생성을 통해 예매→결제→발권 플로우를 끝까지 오류 없이 완료할 수 있도록 수정한다. Cloud Functions 호출, Firestore 데이터 정합성 등 모든 단계 검증.",
      "acceptanceCriteria": [
        "demo_test_screen.dart에서 createOrder → confirmPaymentAndAssignSeats 순차 호출 성공",
        "mock_ticket_screen.dart에서 Firestore 직접 쓰기로 티켓 생성 성공",
        "생성된 티켓이 마이티켓에 정상 표시",
        "오류 발생 시 명확한 에러 메시지 표시 (INTERNAL 에러 X)",
        "flutter analyze 통과"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Cloud Functions는 이미 v1 시그니처로 수정 완료. 클라이언트 호출부가 올바른 파라미터를 보내는지 확인. demo_test_screen.dart, mock_ticket_screen.dart 점검."
    },
    {
      "id": "MT-004",
      "title": "취소/환불 시 좌석 상태 복원 및 엣지케이스 처리",
      "description": "티켓 취소 시 예약된 좌석이 다시 available로 풀리고, 주문/티켓/좌석블록 상태가 일관성 있게 업데이트되는지 확인. 부분 취소(2장 중 1장만), 전체 취소, 이미 입장한 티켓 취소 시도 등 엣지케이스 처리.",
      "acceptanceCriteria": [
        "requestTicketCancellation 호출 시 해당 좌석 status가 available로 복원",
        "event.availableSeats가 +1 증가",
        "주문 내 모든 티켓 취소 시 order.status가 refunded로 변경",
        "부분 취소 시 order.status 유지, canceledCount 증가",
        "이미 체크인된 티켓 취소 시도 시 적절한 에러 메시지",
        "취소 후 마이티켓에서 해당 티켓 상태가 '취소됨'으로 표시",
        "flutter analyze 통과, npm run build 통과"
      ],
      "priority": 4,
      "passes": true,
      "notes": "requestTicketCancellation Cloud Function은 이미 좌석 복원 로직 포함. 클라이언트 UI에서 취소 후 화면 갱신이 제대로 되는지 확인. ticket_detail_screen.dart의 취소 버튼 동작 점검."
    },
    {
      "id": "MT-005",
      "title": "마일리지 데이터 모델 및 Firestore 구조 설계",
      "description": "사용자 마일리지 시스템의 기초 데이터 모델을 설계하고 구현한다. users 문서에 mileage 필드 추가, mileageHistory 컬렉션 생성, 마일리지 적립/차감 Cloud Function 구현.",
      "acceptanceCriteria": [
        "melon_core에 Mileage 모델 추가 (balance, tier, totalEarned)",
        "melon_core에 MileageHistory 모델 추가 (userId, amount, type, reason, createdAt)",
        "type 종류: purchase(구매적립), referral(추천적립), upgrade(등급업 차감)",
        "users 문서에 mileage 필드 추가 (balance: 0, tier: 'bronze', totalEarned: 0)",
        "addMileage Cloud Function: userId, amount, type, reason → mileageHistory 기록 + users.mileage.balance 업데이트",
        "npm run build 통과, flutter analyze 통과"
      ],
      "priority": 5,
      "passes": true,
      "notes": "등급 체계: Bronze(0~) → Silver(5000~) → Gold(15000~) → Platinum(30000~). 구매 적립: 결제금액의 5%. 추천 적립: 추천인에게 500P."
    },
    {
      "id": "MT-006",
      "title": "추천 코드 생성 및 공유하기 기능",
      "description": "각 사용자에게 고유 추천 코드를 부여하고, 공연 상세 페이지에서 추천 코드가 포함된 링크를 공유할 수 있게 한다.",
      "acceptanceCriteria": [
        "users 문서에 referralCode 필드 추가 (최초 로그인 시 8자리 영숫자 자동 생성)",
        "melon_core에 referralCode 생성 유틸 추가",
        "event_detail_screen.dart에 공유 버튼 추가 (Share 아이콘)",
        "공유 시 URL 형식: https://melonticket-web-20260216.vercel.app/event/{eventId}?ref={referralCode}",
        "공유 방법: 클립보드 복사 + 네이티브 Share API (웹: navigator.share, 없으면 클립보드)",
        "공유 성공 시 SnackBar 피드백",
        "flutter analyze 통과"
      ],
      "priority": 6,
      "passes": true,
      "notes": "referralCode는 중복 불가. Firestore에서 유니크 체크. URL의 ref 파라미터는 예매 시 서버로 전달되어 추천인 추적에 사용."
    },
    {
      "id": "MT-007",
      "title": "추천 링크로 예매 시 추천인 마일리지 적립",
      "description": "추천 코드가 포함된 링크로 접속하여 예매를 완료하면, 추천인에게 마일리지가 적립되고 구매자에게도 구매 마일리지가 적립된다.",
      "acceptanceCriteria": [
        "예매 플로우에서 ref 쿼리 파라미터를 추출하여 주문에 저장 (order.referralCode)",
        "confirmPaymentAndAssignSeats에서 결제 성공 시: 구매자에게 결제금액 5% 마일리지 적립",
        "referralCode가 있으면: 추천인 userId 조회 → 추천인에게 500P 적립",
        "자기 자신 추천 방지 (referralCode 소유자 == 구매자이면 무시)",
        "mileageHistory에 적립 내역 기록",
        "npm run build 통과"
      ],
      "priority": 7,
      "passes": true,
      "notes": "createOrder에 referralCode 파라미터 추가. confirmPaymentAndAssignSeats 트랜잭션 외부에서 마일리지 적립 처리 (트랜잭션 무겁지 않게)."
    },
    {
      "id": "MT-008",
      "title": "마이페이지 마일리지 현황 UI",
      "description": "마이페이지에서 현재 마일리지 잔액, 등급, 적립 내역을 확인할 수 있는 UI를 구현한다.",
      "acceptanceCriteria": [
        "마이페이지(또는 마이티켓 화면)에 마일리지 섹션 추가",
        "현재 잔액 표시 (숫자 + P 단위)",
        "현재 등급 표시 (Bronze/Silver/Gold/Platinum + 아이콘/색상)",
        "다음 등급까지 남은 마일리지 프로그레스 바",
        "최근 적립/차감 내역 리스트 (최대 10건, 더보기 가능)",
        "내역 항목: 날짜, 유형(구매/추천/업그레이드), 금액(+/-), 사유",
        "flutter analyze 통과"
      ],
      "priority": 8,
      "passes": true,
      "notes": "디자인: 다크 테마 + 골드 악센트. 등급 색상 - Bronze(#CD7F32), Silver(#C0C0C0), Gold(#C9A84C), Platinum(#E5E4E2). AppTheme 활용."
    },
    {
      "id": "MT-009",
      "title": "마일리지로 좌석 등급 업그레이드",
      "description": "일정 마일리지를 모은 사용자가 보유한 티켓의 좌석 등급을 한 단계 업그레이드할 수 있는 기능. 할인이 아니라 구매 후 업그레이드 개념.",
      "acceptanceCriteria": [
        "티켓 상세 화면에 '좌석 업그레이드' 버튼 추가 (조건 충족 시만 표시)",
        "업그레이드 가능 조건: 티켓 status=issued, 상위 등급 잔여 좌석 존재, 충분한 마일리지",
        "업그레이드 비용: A→S(2000P), S→R(3000P), R→VIP(5000P)",
        "upgradeTicketSeat Cloud Function 구현: 마일리지 차감 + 기존 좌석 available로 반환 + 상위 등급 좌석 배정 + 티켓 seatId 업데이트",
        "업그레이드 성공 시 마일리지 차감 내역 기록 (type: upgrade)",
        "업그레이드 후 티켓 상세 화면에 새 좌석 정보 반영",
        "npm run build 통과, flutter analyze 통과"
      ],
      "priority": 9,
      "passes": true,
      "notes": "VIP는 더 이상 업그레이드 불가. 상위 등급 좌석이 없으면 '잔여 좌석이 없습니다' 메시지. 트랜잭션으로 좌석 교환 원자성 보장."
    },
    {
      "id": "MT-010",
      "title": "추천 코드 & 마일리지 어드민 관리",
      "description": "어드민 대시보드에서 사용자별 마일리지 현황, 추천 통계, 수동 마일리지 지급/차감이 가능한 관리 화면을 추가한다.",
      "acceptanceCriteria": [
        "admin 사이드바에 '마일리지 관리' 메뉴 추가",
        "사용자별 마일리지 잔액, 등급, 추천 횟수 목록 표시",
        "수동 마일리지 지급/차감 기능 (관리자용)",
        "추천 통계: 총 추천 수, 추천으로 발생한 예매 수",
        "flutter analyze 통과"
      ],
      "priority": 10,
      "passes": true,
      "notes": "melon_admin에 구현. AdminTheme, shadcn_flutter 사용. 기존 admin_orders_screen 스타일 참고."
    },
    {
      "id": "MT-011",
      "title": "취소/환불 수수료 규정 적용",
      "description": "실제 티켓 서비스 기준의 취소 수수료 체계를 적용한다. 예매 후 7일 이내 무료취소, 이후 시점별 수수료 부과. Cloud Function + 클라이언트 UI에 규정 안내 표시.",
      "acceptanceCriteria": [
        "requestTicketCancellation Cloud Function 수수료 로직 변경:",
        "  - 예매 후 7일 이내: 취소 수수료 없음 (100% 환불)",
        "  - 예매 후 8일 ~ 관람일 10일 전: 뮤지컬/콘서트/클래식 등 공연권 4,000원 / 연극/전시 등 입장권 2,000원 (단, 티켓금액의 10% 이내)",
        "  - 관람일 9일 전 ~ 7일 전: 티켓금액의 10%",
        "  - 관람일 6일 전 ~ 3일 전: 티켓금액의 20%",
        "  - 관람일 2일 전 ~ 1일 전: 티켓금액의 30%",
        "  - 관람 당일: 취소/환불 불가",
        "  - 예매당일 취소 시 예매수수료 환불 안 됨 (예매당일 외에는 환불)",
        "티켓 상세 및 취소 확인 다이얼로그에 수수료 미리보기 표시",
        "결제(checkout) 화면에서 취소 수수료 규정 안내 표시 (결제 전 사용자에게 취소 시 수수료 발생 가능 고지)",
        "취소 수수료 안내 페이지/바텀시트 추가",
        "npm run build 통과, flutter analyze 통과"
      ],
      "priority": 11,
      "passes": true,
      "notes": "기존 단순 24시간/3시간 기준 로직을 실제 규정으로 교체. Event.category에 따라 공연권/입장권 구분 (콘서트,뮤지컬,클래식=공연권 4000원, 연극,전시=입장권 2000원). 예매일은 order.createdAt 기준."
    },
    {
      "id": "MT-012",
      "title": "공연 상세 360° 좌석뷰 태그 표시",
      "description": "공연 상세 페이지의 카테고리 태그(콘서트) 옆에, 해당 공연장에 좌석 시야 사진이 있는 경우 '360° 좌석뷰' 태그를 추가 표시한다.",
      "acceptanceCriteria": [
        "event_detail_screen 또는 mobile_main_screen의 공연 카드에서 카테고리 태그 옆에 '360° 좌석뷰' 태그 추가",
        "해당 공연의 venueId로 venueSeatViews 컬렉션에 is360=true인 문서가 1건 이상 있을 때만 표시",
        "태그 스타일: 골드 계열, 기존 카테고리 태그와 일관된 디자인",
        "flutter analyze 통과"
      ],
      "priority": 12,
      "passes": true,
      "notes": "venueSeatViews 컬렉션에서 venueId 기준 쿼리. 성능을 위해 캐싱 또는 events 문서에 has360View 불리언 필드 추가 고려. 모바일 메인의 바로예매 카드에도 적용."
    },
    {
      "id": "MT-013",
      "title": "임시 게스트 계정으로 예매~발권 체험 기능",
      "description": "로그인 없이 임시 계정을 생성하여 좌석 선택 → 예매 → 발권까지 전체 플로우를 체험할 수 있는 기능. 나중에 제거 예정인 테스트/데모용 기능.",
      "acceptanceCriteria": [
        "로그인 화면 또는 예매 진입 시 '체험하기' 버튼 추가",
        "Firebase Anonymous Auth로 임시 계정 생성",
        "임시 계정으로 좌석 선택 → 결제(무료/모의) → 티켓 발권 전체 플로우 가능",
        "임시 계정 사용자에게 '체험 모드' 표시 (프로필에 뱃지)",
        "체험 계정의 티켓은 실제 좌석 차지하지 않거나, 별도 플래그(isDemo) 표시",
        "나중에 기능 제거를 위한 플래그/조건부 코드 사용",
        "flutter analyze 통과, npm run build 통과"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Firebase Anonymous Auth 사용. 체험 주문에는 order.isDemo=true 플래그. Cloud Function에서 isDemo 주문은 실제 좌석 reserve 안 하거나 별도 처리. 임시 기능이므로 조건부 코드로 쉽게 제거 가능하게."
    },
    {
      "id": "MT-014",
      "title": "마일리지 보상 시스템 확장 (구매량·리뷰·뱃지)",
      "description": "마일리지 적립 체계를 확장한다. 많이 구매할수록 더 높은 비율로 적립되고, 리뷰 작성 시 마일리지 + 뱃지 보상을 제공한다.",
      "acceptanceCriteria": [
        "구매 마일리지 적립률 등급별 차등: Bronze 3%, Silver 5%, Gold 7%, Platinum 10%",
        "리뷰 작성 기능 추가: 관람 완료 티켓에 별점(1~5) + 한줄평 작성 가능",
        "리뷰 작성 시 마일리지 적립 (예: 200P, 첫 리뷰 500P)",
        "리뷰 작성자 닉네임 옆에 '리뷰어' 뱃지 표시",
        "뱃지 시스템: 첫 리뷰(🎭), 3회 리뷰(⭐), 10회 리뷰(👑) 등 단계별 뱃지",
        "리뷰 모델: reviews 컬렉션 (userId, eventId, ticketId, rating, comment, createdAt)",
        "마이페이지에 내 리뷰 목록 + 뱃지 표시",
        "공연 상세에 리뷰 섹션 (평균 별점 + 최근 리뷰)",
        "flutter analyze 통과, npm run build 통과"
      ],
      "priority": 14,
      "passes": true,
      "notes": "MileageType에 'review' 추가. AppUser에 badges 필드(리스트) 추가. 뱃지 종류: first_review, reviewer_3, reviewer_10, top_buyer 등. 리뷰는 관람 완료(status=used) 티켓만 작성 가능. 중복 리뷰 방지(eventId+userId 유니크)."
    },
    {
      "id": "MT-015",
      "title": "공연 운영 대시보드 - 최근 공연 옵션 메뉴",
      "description": "어드민 공연 운영 대시보드의 최근 공연 목록에서 각 공연을 클릭하면 옵션 메뉴(수정, 삭제, 좌석현황, 주문목록 등)가 나오도록 한다.",
      "acceptanceCriteria": [
        "최근 공연 리스트 아이템 클릭 시 컨텍스트 메뉴/팝업 메뉴 표시",
        "메뉴 항목: 공연 수정, 공연 삭제, 좌석 현황 보기, 주문 목록, 공연 복제",
        "공연 수정: event_create_screen으로 editMode 이동",
        "공연 삭제: 확인 다이얼로그 후 status를 canceled로 변경",
        "좌석 현황: 해당 공연의 좌석별 예매/잔여 현황",
        "주문 목록: 해당 공연의 주문 필터링",
        "공연 복제: 기존 공연 데이터 기반으로 새 공연 등록 폼 열기",
        "flutter analyze 통과"
      ],
      "priority": 15,
      "passes": true,
      "notes": "melon_admin에 구현. shadcn_flutter의 DropdownMenu 또는 PopupMenuButton 사용. 기존 admin_events_screen 또는 dashboard의 공연 목록 부분에 적용."
    },
    {
      "id": "MT-016",
      "title": "공연 등록 - 주최/기획 예시 텍스트 제거",
      "description": "공연 등록 화면의 주최, 기획 입력 필드에서 예시(placeholder) 텍스트를 제거한다.",
      "acceptanceCriteria": [
        "event_create_screen.dart의 주최 필드 placeholder 제거 또는 빈 문자열로 변경",
        "기획 필드 placeholder 제거 또는 빈 문자열로 변경",
        "flutter analyze 통과"
      ],
      "priority": 16,
      "passes": true,
      "notes": "간단한 UI 변경. _field('주최', ...) 와 _field('기획', ...)의 decoration에서 hintText 제거."
    },
    {
      "id": "MT-017",
      "title": "공연 등록 - 다회 공연(연속 회차) 지원",
      "description": "하루 1회 공연뿐만 아니라, 여러 날짜에 걸쳐 여러 회차를 등록할 수 있도록 공연 등록 UI와 데이터 모델을 확장한다.",
      "acceptanceCriteria": [
        "Event 모델에 회차(sessions) 개념 추가 또는 상위 시리즈 모델 도입",
        "공연 등록 UI에 '회차 추가' 버튼 → 날짜/시간별 여러 회차 입력 가능",
        "각 회차별 독립적인 startAt, saleStartAt, saleEndAt, 좌석 관리",
        "공연 상세에서 회차 선택 UI (날짜/시간 탭 또는 드롭다운)",
        "같은 공연장이라도 회차별 좌석이 독립적으로 관리됨",
        "어드민에서 회차별 판매현황 확인 가능",
        "flutter analyze 통과, npm run build 통과"
      ],
      "priority": 17,
      "passes": true,
      "notes": "접근법 2가지: (1) EventSeries 상위 모델 + 회차별 Event 문서, (2) Event에 sessions 배열. 추천: (1)이 확장성 좋음. EventSeries(title,poster,category) → Event(seriesId,sessionNumber,startAt,seats). 기존 단일 공연도 sessions=1인 시리즈로 호환. 공연 등록 UI에서 '단일 공연' / '연속 공연' 토글."
    },
    {
      "id": "MT-018",
      "title": "엑셀 좌석배치도 업로드 → 인터랙티브 도트맵 좌석 선택 시스템",
      "description": "관리자가 좌석 등급별로 나눠진 좌석배치도 엑셀 파일을 업로드하면, 시스템이 분석하여 도트 기반 인터랙티브 좌석 배치도를 자동 생성한다. 사용자는 이 도트맵에서 개별 좌석을 클릭하여 예매할 수 있다. 가장 핵심 기능.",
      "acceptanceCriteria": [
        "어드민: 엑셀(.xlsx) 파일 업로드 기능 (공연장 등록 또는 공연 등록 시)",
        "엑셀 파싱: 좌석 등급(VIP/R/S/A), 구역, 층, 열, 좌석번호 자동 인식",
        "엑셀 데이터 → Firestore seats 컬렉션으로 변환 저장 (venueId, zone, floor, row, seatNumber, grade, x, y 좌표)",
        "어드민: 파싱 결과 미리보기 (도트맵으로 시각화, 등급별 색상 구분)",
        "어드민: 미리보기에서 좌석 위치/등급 수동 조정 가능",
        "어드민: 수동 편집 모드 — 그리드 도트(빈 자리)가 깔린 캔버스에서, 현재 선택된 좌석 등급으로 빈 도트 클릭하면 해당 등급 좌석으로 채워짐",
        "어드민: 상단 툴바에서 등급(VIP/R/S/A) 선택 후 빈 도트 클릭 = 페인트 방식으로 좌석 배치",
        "어드민: 개별 좌석 클릭 → 속성 편집 (등급, 구역, 열, 번호 변경)",
        "어드민: 좌석 유형 설정 — 일반석, 장애인석(휠체어), 유보석(판매 보류) 지원",
        "어드민: 장애인석은 별도 아이콘/색상 표시, 유보석은 예매 불가 상태로 잠금",
        "어드민: 좌석 드래그 이동, 다중 선택 후 일괄 등급/유형 변경",
        "티켓앱: Canvas 기반 인터랙티브 도트맵 좌석 선택 UI",
        "티켓앱: 핀치 줌/패닝, 등급별 색상 구분 (VIP=골드, R=레드, S=블루, A=그린)",
        "티켓앱: 좌석 클릭 시 좌석 정보 표시 (등급, 구역, 열, 번호, 가격)",
        "티켓앱: 선택한 좌석 실시간 예매 상태 반영 (available/reserved/sold 색상 구분)",
        "티켓앱: 다중 좌석 선택 지원 (최대 maxTicketsPerOrder 매수까지)",
        "무대 위치 표시 (상단/하단)",
        "기존 자동 생성 좌석 구조와 호환 (엑셀 업로드 or 기존 방식 선택 가능)",
        "flutter analyze 통과, npm run build 통과"
      ],
      "priority": 1,
      "passes": true,
      "notes": "핵심 기능. 기존 프리셋 방식 대체. 엑셀 파싱은 Cloud Function(xlsx 라이브러리) 또는 클라이언트(dart excel 패키지). 좌석 좌표(x,y)는 엑셀의 행/열 위치에서 자동 계산하되, 어드민에서 드래그로 조정 가능하게. 도트맵 렌더링은 CustomPainter + GestureDetector. 대규모 공연장(1000석+)에서도 성능 유지 필요. 좌석 등급 색상: VIP=#C9A84C(골드), R=#E53935(레드), S=#1E88E5(블루), A=#43A047(그린). sold=#555555(회색), reserved=#FFA000(주황). 좌석 유형(seatType): normal(일반), wheelchair(장애인석), reserved_hold(유보석). 유보석은 어드민만 해제 가능. 수동 편집 모드: 그리드 도트(빈 원) 캔버스가 기본 → 등급 선택 후 빈 도트 클릭하면 해당 등급 색상으로 채워짐(페인트 방식). 채워진 좌석 클릭하면 비우기/등급변경. Delete키로 삭제."
    },
    {
      "id": "MT-019",
      "title": "비지정석(스탠딩) 예매 모드 지원",
      "description": "공연 등록 시 '비지정석' 옵션을 설정할 수 있게 하여, 모든 좌석이 등급 없이 배정되고 입장번호만 부여되는 스탠딩 공연 예매를 지원한다.",
      "acceptanceCriteria": [
        "Event 모델에 isStanding(비지정석) 불리언 필드 추가",
        "어드민 공연 등록 시 '비지정석(스탠딩)' 토글 추가 — ON 시 좌석 배치/등급 설정 비활성화",
        "비지정석 공연은 좌석 등급 없이 단일 가격으로 운영",
        "예매 시 좌석 선택 UI 대신 수량 선택 UI 표시",
        "발권 시 좌석번호 대신 입장번호(순번) 부여 (예: 입장번호 #001, #002...)",
        "티켓 상세에서 '입장번호' 표시 (좌석 정보 대신)",
        "QR 체크인 시 입장번호 기반 처리",
        "flutter analyze 통과, npm run build 통과"
      ],
      "priority": 19,
      "passes": true,
      "notes": "스탠딩 공연, 페스티벌 등 좌석 지정이 필요 없는 공연 유형 지원. isStanding=true이면 seats 컬렉션 사용 안 하고, 티켓에 entryNumber 필드 추가. 입장번호는 예매 순서대로 자동 부여. maxTicketsPerOrder로 1인 최대 구매 수량 제한은 동일하게 적용."
    },
    {
      "id": "MT-020",
      "title": "정산 시스템 — 공연 후 수수료 차감 및 계좌 입금 승인",
      "description": "티켓 판매 금액이 공연 종료 후 관리자가 수수료를 차감하고 최종 승인하면, 등록된 주최자 계좌로 정산금이 입금되는 정산 프로세스를 구현한다.",
      "acceptanceCriteria": [
        "Event 모델 또는 별도 Settlement 모델에 정산 관련 필드 추가 (수수료율, 정산상태, 정산일, 정산계좌 등)",
        "어드민 공연 등록 시 정산 계좌 정보 입력 (은행명, 계좌번호, 예금주)",
        "어드민 정산 관리 화면 추가 — 공연별 총 매출, 수수료, 정산 예정액 표시",
        "공연 종료 후 관리자가 수수료율(%) 설정 및 '정산 승인' 버튼 클릭",
        "정산 승인 시 Settlement 문서 생성 (eventId, totalSales, feeRate, feeAmount, settlementAmount, bankInfo, status, approvedAt)",
        "정산 상태: pending(대기) → approved(승인) → transferred(입금완료)",
        "정산 내역 히스토리 조회 가능",
        "flutter analyze 통과, npm run build 통과"
      ],
      "priority": 20,
      "passes": true,
      "notes": "실제 은행 송금 API 연동은 추후. 현재는 관리자가 수동으로 '입금완료' 상태 변경하는 방식. 수수료율 기본값: 10%. 정산 계좌는 주최자(organizer)에 연결. settlements 컬렉션에 문서 저장."
    },
    {
      "id": "MT-021",
      "title": "최근 공연 목록 — 행 전체 클릭으로 옵션 메뉴 열기",
      "description": "어드민 대시보드의 최근 공연 목록에서 '옵션' 버튼뿐만 아니라, 해당 공연 행(row) 어디를 클릭해도 옵션 안내창이 뜨도록 개선한다.",
      "acceptanceCriteria": [
        "최근 공연 리스트의 각 행 전체를 클릭 가능 영역으로 설정",
        "행 어디를 클릭해도 기존 '옵션' 버튼과 동일한 옵션 메뉴/팝업 표시",
        "행 hover 시 배경색 변화로 클릭 가능함을 시각적으로 안내",
        "기존 '옵션' 버튼은 유지하되, 행 클릭과 동일 동작",
        "flutter analyze 통과"
      ],
      "priority": 21,
      "passes": true,
      "notes": "InkWell 또는 GestureDetector로 행 전체 감싸기. 기존 옵션 메뉴 로직 재활용. hover 효과는 AdminTheme.sage.withValues(alpha: 0.08) 정도."
    },
    {
      "id": "MT-022",
      "title": "어드민 대시보드 배너 및 UI 입체감 개선",
      "description": "공연장 관리, 새 공연 등록 배너를 더 크고 입체감 있게 만들고, 공연 운영 대시보드에 그림자 효과를 넣고, 어드민 전체 텍스트에 그림자를 적용하여 검정 배경에서 묻히지 않도록 한다.",
      "acceptanceCriteria": [
        "공연장 관리 / 새 공연 등록 배너 크기 확대 (높이 증가, 패딩 확대)",
        "배너에 그라디언트, 보더, 박스쉐도우 등 입체감 효과 추가",
        "공연 운영 대시보드 카드/섹션에 boxShadow 효과 적용",
        "AdminTheme에 텍스트 그림자 유틸 추가 (모든 주요 텍스트에 미묘한 그림자)",
        "어드민 전체 텍스트가 검정 배경에서 선명하게 보이도록 textShadow 적용",
        "기존 디자인 톤(다크+골드) 유지하면서 깊이감 추가",
        "flutter analyze 통과"
      ],
      "priority": 22,
      "passes": true,
      "notes": "AdminTheme에 textShadow 스타일 헬퍼 추가. boxShadow는 어두운 테마에 맞게 미묘하게 — 예: BoxShadow(color: Colors.black54, blurRadius: 12, offset: Offset(0,4)). 배너는 현재 OutlinedButton 기반 → Container + 그라디언트 + 아이콘 + 텍스트로 리디자인. 과하지 않게 우아한 입체감."
    },
    {
      "id": "MT-023",
      "title": "어드민 사이드바 — 접이식 오버레이 메뉴 (드로어)",
      "description": "어드민 왼쪽 사이드바 네비게이션을 고정형이 아닌, 어떤 화면에서든 열고 닫을 수 있는 오버레이(드로어) 방식으로 변경한다. 햄버거 메뉴 버튼으로 토글하며, 메뉴가 콘텐츠 위에 팝업처럼 슬라이드 인/아웃된다.",
      "acceptanceCriteria": [
        "사이드바가 기본적으로 접혀 있고, 햄버거 아이콘 클릭 시 슬라이드 인으로 열림",
        "사이드바 바깥 영역 클릭 시 자동으로 닫힘",
        "사이드바가 콘텐츠 영역 위에 오버레이로 표시 (콘텐츠 밀어내기 X)",
        "열릴 때 반투명 배경(scrim) 표시로 포커스 유도",
        "메뉴 항목 클릭 시 해당 화면으로 이동 + 사이드바 자동 닫힘",
        "슬라이드 애니메이션 (300ms 정도, ease-in-out)",
        "모든 어드민 화면 상단에 햄버거 메뉴 버튼 통일 배치",
        "flutter analyze 통과"
      ],
      "priority": 23,
      "passes": true,
      "notes": "Flutter Drawer 또는 커스텀 AnimatedContainer + Overlay 사용. 현재 Row(sidebar, content) 구조를 Scaffold + Drawer 또는 Stack 기반으로 변경. 사이드바 열린 상태에서 ESC 키로도 닫기. 기존 메뉴 항목(대시보드, 공연관리, 통계, 공연장관리, 마일리지관리, 데모테스트, 모의티켓생성) 그대로 유지."
    },
    {
      "id": "MT-024",
      "title": "멀티 셀러 플랫폼 — 개별 어드민(판매자) 계정 시스템",
      "description": "스마트스토어처럼 누구나 자신의 어드민 계정을 만들어 공연을 올리고 수익을 받을 수 있는 멀티 셀러 플랫폼 구조로 전환한다. 슈퍼어드민(플랫폼 운영자)은 모든 셀러 계정을 관리한다.",
      "acceptanceCriteria": [
        "역할 체계 도입: superAdmin(플랫폼 운영자), seller(판매자/주최자), user(일반 사용자)",
        "AppUser 모델에 role 필드 추가 (superAdmin / seller / user)",
        "셀러 가입 플로우: 일반 사용자가 '판매자 등록' 신청 → 사업자 정보 입력 (상호명, 사업자번호, 대표자명, 연락처)",
        "슈퍼어드민 승인 후 seller 역할 활성화",
        "셀러별 독립 대시보드: 자신이 등록한 공연만 조회/관리 (venueId, eventId에 sellerId 연결)",
        "슈퍼어드민 대시보드: 모든 셀러 목록, 전체 공연 통합 관리, 셀러 승인/정지/탈퇴 처리",
        "Event 모델에 sellerId 필드 추가 — 공연 등록 시 자동으로 현재 셀러 ID 저장",
        "셀러는 자기 공연의 주문/좌석/통계만 접근 가능 (Firestore Security Rules로 격리)",
        "슈퍼어드민은 모든 데이터 접근 가능",
        "셀러 프로필 페이지: 상호명, 로고, 소개글, 연락처 관리",
        "티켓앱에서 공연 상세에 판매자(주최자) 정보 표시",
        "flutter analyze 통과, npm run build 통과"
      ],
      "priority": 24,
      "passes": true,
      "notes": "핵심 아키텍처 변경. users 컬렉션에 role, sellerProfile(상호명, 사업자번호, 대표자명, 연락처, 로고URL, 소개글, 가입일, 상태) 서브맵 추가. Firestore Security Rules에서 seller는 자기 sellerId 데이터만 읽기/쓰기. superAdmin은 모든 것에 접근. 기존 isAdmin 필드는 role=='superAdmin' || role=='seller'로 대체. 라우팅에서 역할별 접근제어 적용."
    },
    {
      "id": "MT-025",
      "title": "에스크로 결제 시스템 — 예치금 기반 안전 결제/환불",
      "description": "네이버 스마트스토어 방식의 에스크로 결제 시스템을 구현한다. 결제 시 금액이 플랫폼에 예치되고, 공연 완료 후 수수료를 제외한 금액이 셀러에게 정산된다. 환불/취소 시 예치금에서 차감하여 즉시 환불 처리한다.",
      "acceptanceCriteria": [
        "── 데이터 모델 ──",
        "EscrowAccount 모델: sellerId, balance(예치 잔액), pendingAmount(정산 대기금), totalDeposited(총 입금액), totalWithdrawn(총 출금액)",
        "EscrowTransaction 모델: id, sellerId, orderId, type(deposit/refund/settlement/platformFee), amount, balanceBefore, balanceAfter, description, createdAt",
        "Settlement 모델: id, sellerId, eventId, period, totalSales, refundAmount, platformFeeRate, platformFeeAmount, settlementAmount, bankInfo, status(pending/approved/transferred), requestedAt, approvedAt, transferredAt",
        "",
        "── 결제 플로우 (입금) ──",
        "사용자 결제 성공 시 → EscrowAccount.balance에 결제금액 전액 적립",
        "EscrowTransaction 기록 (type=deposit, +금액)",
        "Order에 escrowStatus 필드 추가 (deposited/partially_refunded/fully_refunded/settled)",
        "Ticket 발급은 즉시 진행 (결제 완료 = 티켓 발급)",
        "",
        "── 환불 플로우 (출금) ──",
        "취소 요청 시 EscrowAccount.balance에서 환불금액 차감",
        "환불 전 잔액 충분 여부 더블체크 (balance >= refundAmount)",
        "EscrowTransaction 기록 (type=refund, -금액, balanceBefore/After 기록)",
        "수수료 공제 후 환불금 계산: refundAmount = ticketPrice - cancellationFee",
        "환불 처리 후 Order.escrowStatus 업데이트",
        "부분 취소(N장 중 일부): 해당 티켓 금액만 환불, 나머지 예치 유지",
        "",
        "── 정산 플로우 ──",
        "공연 종료 + 환불 가능 기간(7일) 경과 후 정산 가능 상태로 전환",
        "셀러가 '정산 요청' → 슈퍼어드민이 검토 후 '정산 승인'",
        "정산 금액 = 총 매출 - 환불 금액 - 플랫폼 수수료",
        "플랫폼 수수료 EscrowTransaction 기록 (type=platformFee)",
        "정산 EscrowTransaction 기록 (type=settlement, -정산금액)",
        "EscrowAccount.balance 차감, pendingAmount 차감",
        "Settlement.status를 transferred로 변경",
        "",
        "── 안전장치 (더블체크) ──",
        "모든 금액 변동은 Firestore Transaction으로 원자성 보장",
        "balanceBefore + amount == balanceAfter 검증 (매 트랜잭션)",
        "EscrowAccount.balance는 음수 불가 — 환불 시 잔액 부족이면 충전 유도 후 재시도",
        "",
        "── 에스크로 충전 (잔액 부족 대응) ──",
        "슈퍼어드민이 셀러 에스크로 계정에 수동 충전 가능 (type=topup)",
        "셀러가 직접 충전 요청 → 슈퍼어드민 승인 후 잔액 반영",
        "환불 시 잔액 부족이면: 환불 보류(pending_refund) 상태 → 셀러에게 충전 요청 알림 → 충전 완료 후 자동 환불 재처리",
        "충전 금액도 EscrowTransaction으로 기록 (type=topup, +금액, balanceBefore/After)",
        "슈퍼어드민 대시보드에서 잔액 부족 셀러 목록 하이라이트 표시",
        "정산 시 해당 이벤트의 모든 주문 상태 재검증 (미처리 환불 건 확인)",
        "일일 정산 검증 배치: escrowTransactions 합계 == escrowAccount.balance 일치 확인",
        "슈퍼어드민 에스크로 대시보드: 전체 예치금 현황, 셀러별 잔액, 트랜잭션 로그 실시간 조회",
        "금액 계산은 모두 정수(원 단위) — 소수점 반올림 오차 방지",
        "",
        "flutter analyze 통과, npm run build 통과"
      ],
      "priority": 25,
      "passes": true,
      "notes": "가장 중요한 금융 로직. 빈틈없이 구현해야 함. escrowAccounts/{sellerId} 컬렉션, escrowTransactions/{txId} 컬렉션 사용. 모든 금액 변동은 Cloud Function 내 runTransaction으로 처리. 동시 요청(환불+정산 동시) 시에도 데이터 정합성 보장. balanceBefore/balanceAfter로 이중 장부 검증. 실제 PG 연동은 추후(현재는 모의 결제) — 하지만 에스크로 장부 로직은 실전 수준으로 구현. 수수료율은 셀러별/이벤트별 커스텀 가능(기본 10%). 환불 가능 기간(7일)은 설정 가능하게. 충전(topup) 시나리오: 셀러가 정산 후 잔액 0인 상태에서 환불 발생 → 잔액 부족 → 환불 보류(pending_refund) → 셀러에게 충전 알림 → 충전 완료 시 보류 환불 자동 재처리. EscrowTransaction type 종류: deposit(입금), refund(환불), settlement(정산), platformFee(수수료), topup(충전). pending_refund 상태인 주문은 별도 큐로 관리하여 충전 시 FIFO로 처리."
    },
    {
      "id": "MT-026",
      "title": "슈퍼어드민 — 셀러 관리 및 에스크로 모니터링 대시보드",
      "description": "슈퍼어드민(플랫폼 운영자) 전용 화면으로, 모든 셀러 계정 관리, 에스크로 잔액 모니터링, 정산 승인, 트랜잭션 로그 감사를 수행할 수 있는 통합 대시보드를 구축한다.",
      "acceptanceCriteria": [
        "슈퍼어드민 전용 메뉴: 셀러 관리, 에스크로 현황, 정산 관리, 감사 로그",
        "셀러 관리: 가입 신청 목록 / 승인 / 정지 / 탈퇴 처리",
        "셀러 상세: 프로필, 등록 공연 목록, 매출 통계, 에스크로 잔액",
        "에스크로 현황: 플랫폼 전체 예치금 총합, 셀러별 잔액 목록, 이상 거래 알림",
        "정산 관리: 정산 요청 목록, 금액 검증, 승인/거절, 입금 완료 처리",
        "감사 로그: escrowTransactions 전체 조회 (필터: 셀러, 기간, 유형, 금액 범위)",
        "일일 정합성 체크 결과 표시 (트랜잭션 합계 vs 잔액 불일치 건 하이라이트)",
        "슈퍼어드민만 접근 가능 (role 기반 라우팅 가드)",
        "flutter analyze 통과"
      ],
      "priority": 26,
      "passes": true,
      "notes": "melon_admin에 구현. 슈퍼어드민 전용 라우트/화면. 셀러 관리 CRUD + 상태 변경. 에스크로 대시보드는 실시간 Firestore 스트림. 정산 승인은 더블 확인 다이얼로그. 감사 로그는 페이지네이션 + 필터 + CSV 내보내기. AdminTheme 기반 UI."
    },
    {
      "id": "MT-027",
      "title": "공연 삭제 보호 — 예매자 존재 시 삭제 차단 및 전원 환불 후 삭제",
      "description": "공연 삭제 시 예매자가 1명이라도 있으면 삭제를 절대 차단한다. 모든 예매자에게 환불 조치를 완료한 후에만 삭제가 가능하도록 한다.",
      "acceptanceCriteria": [
        "공연 삭제 요청 시 해당 이벤트의 활성 티켓(status=issued/reserved) 수를 조회",
        "활성 티켓이 1건이라도 있으면 삭제 차단 — '예매자 N명이 있어 삭제할 수 없습니다' 에러 표시",
        "삭제 차단 시 '전체 환불 후 삭제' 안내 메시지 + 환불 처리 화면으로 이동 버튼 제공",
        "전체 환불 기능: 해당 공연의 모든 활성 티켓을 일괄 취소/환불 처리하는 Cloud Function",
        "일괄 환불 시 각 티켓별로 환불 금액 계산 (수수료 정책에 따라) 및 에스크로 차감",
        "일괄 환불 진행 중 프로그레스 표시 (N/M건 처리 중...)",
        "일괄 환불 완료 후 → 공연 삭제 가능 상태로 전환",
        "삭제 전 최종 확인 다이얼로그: '환불 완료된 공연입니다. 정말 삭제하시겠습니까?'",
        "삭제 시 Event.status를 deleted로 변경 (실제 Firestore 문서 삭제가 아닌 소프트 삭제)",
        "삭제된 공연은 목록에서 숨김, 슈퍼어드민만 감사용으로 조회 가능",
        "이미 체크인(used) 된 티켓이 있는 공연은 삭제 불가 (공연 완료 상태이므로)",
        "flutter analyze 통과, npm run build 통과"
      ],
      "priority": 27,
      "passes": true,
      "notes": "안전 제일. 삭제는 소프트 삭제(status=deleted)로 처리하여 데이터 복구 가능. Cloud Function에서 삭제 전 더블체크: tickets 컬렉션에서 eventId 일치 + status in [issued, reserved] 쿼리. 일괄 환불은 batch write로 처리하되, 에스크로 차감은 건별 트랜잭션. 환불 실패 건이 있으면 삭제 차단 유지. EventStatus enum에 deleted 추가."
    },
    {
      "id": "MT-028",
      "title": "Hall — 공연 커뮤니티 채널 (리뷰 공유 + 팬 소통)",
      "description": "공연별 커뮤니티 공간 'Hall'을 만든다. 같은 공연(다른 지역/날짜)끼리 그룹으로 묶어 리뷰를 통합 공유하고, 공연 전후로 팬들이 후기·의견·사진을 올리며 소통할 수 있는 채널이다. 네이버 스마트스토어의 그룹 리뷰 공유와 유사한 개념.",
      "acceptanceCriteria": [
        "── Hall 데이터 모델 ──",
        "Hall 모델: id, name(공연명), description, coverImageUrl, createdBy(셀러ID), tags, followerCount, createdAt",
        "HallPost 모델: id, hallId, userId, type(review/discussion/photo/notice), content, rating(리뷰일 때 1~5), imageUrls[], likeCount, commentCount, createdAt",
        "HallComment 모델: id, postId, userId, content, createdAt",
        "halls 컬렉션, hallPosts 서브컬렉션, hallComments 서브컬렉션",
        "",
        "── 공연-Hall 연결 (그룹 리뷰 공유) ──",
        "Event 모델에 hallId 필드 추가 — 같은 공연(다른 지역/날짜)은 동일 hallId 공유",
        "공연 등록 시 셀러가 기존 Hall 선택 또는 새 Hall 생성",
        "같은 hallId를 가진 모든 이벤트의 리뷰가 통합 표시 (지역/날짜 무관)",
        "리뷰 작성 시 어느 이벤트에서 작성했는지 표시 (예: '서울 4/30 공연 관람')",
        "다른 셀러의 Hall에도 연결 가능 (셀러 간 같은 공연 그룹화) — 슈퍼어드민 승인 필요",
        "",
        "── 리뷰 시스템 ──",
        "관람 완료(티켓 status=used) 사용자만 리뷰 작성 가능",
        "리뷰: 별점(1~5) + 텍스트 + 사진(최대 5장)",
        "리뷰 평균 별점 Hall 상단에 표시",
        "리뷰 정렬: 최신순 / 별점 높은순 / 별점 낮은순 / 좋아요순",
        "중복 리뷰 방지: 같은 사용자가 같은 eventId에 리뷰 1건만 가능",
        "리뷰 작성 시 마일리지 적립 (MT-014와 연계)",
        "",
        "── 커뮤니티 기능 ──",
        "Hall 팔로우: 사용자가 Hall을 팔로우하면 새 글 알림",
        "글 유형: 리뷰(review), 자유 토론(discussion), 사진(photo), 공지(notice — 셀러만)",
        "좋아요(하트) + 댓글 기능",
        "셀러가 공지글 작성 가능 (다음 공연 안내, 이벤트 등)",
        "Hall 검색: 공연명, 아티스트명으로 검색",
        "",
        "── UI ──",
        "티켓앱: 공연 상세 하단에 'Hall 입장' 버튼 → Hall 화면으로 이동",
        "티켓앱: Hall 탭 또는 메뉴 (팔로우 중인 Hall 목록)",
        "Hall 화면: 커버 이미지 + 공연명 + 평균 별점 + 팔로워 수 + 탭(리뷰/토론/사진/공지)",
        "어드민: 셀러가 자기 Hall 관리 (공지 작성, 부적절 글 삭제/숨김)",
        "flutter analyze 통과, npm run build 통과"
      ],
      "priority": 28,
      "passes": true,
      "notes": "Hall = 공연 커뮤니티 채널. 핵심은 같은 공연 그룹화로 리뷰 통합. halls/{hallId}/posts/{postId}/comments/{commentId} 구조. Event.hallId로 연결. Hall 팔로우는 users/{uid}/followedHalls 서브컬렉션 또는 hallFollowers/{hallId}/users. 리뷰 평균 별점은 Hall 문서에 averageRating, reviewCount 캐시 필드 유지 (Cloud Function onWrite 트리거로 갱신). 부적절 콘텐츠 신고 기능은 추후. 사진 업로드는 Firebase Storage halls/{hallId}/posts/{postId}/ 경로."
    }
  ]
}
